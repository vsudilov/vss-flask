{% extends "base.html" %}
{% block content %}
<script src="/static/js/d3.v3.min.js"></script>
<script>
$(document).ready(function(){

  $('#btn-base').button('toggle')

  $(document).on('click','button',function() {
    var id = $(this).attr('id')
    console.log(id)
    $.ajax({
        type: 'POST',
        url: '/projects/parxiv/',
        data: {
          'test':'testdata'
        },
        dataType: 'json',
        success: function(data, textStatus, jqXHR){
          console.log(data)
        },
        error: function(jqXHR,textStatus,errorThrown) {
          console.log(textStatus,errorThrown)
        }
    });
  });
  var mapping = {
    "one": {
      "data" :{{top_by_papercount|safe}},
      "color": d3.rgb(135,206,235),
      "links": {{relationships_by_papercount|safe}},
    },
    
    "two": {
      "data": {{top_by_citationcount|safe}},
      "color": d3.rgb(255,99,71),
      "links": {{relationships_by_citationcount|safe}},
    },

    "three": {
      "data": {{top_by_citationsperpaper|safe}},
      "color": d3.rgb(205,133,63),
      "links": {{relationships_by_citationsperpaper|safe}},
    },
  }

  var makeLinks = function (data) {
    var median = function (values) {
 
      values.sort( function(a,b) {return a - b;} );
       
      var half = Math.floor(values.length/2);
       
      if (values.length % 2)
        return values[half];
      else
        return (values[half-1] + values[half]) / 2.0;
    }

    var links = []
    var flattenedData = Array.prototype.concat.apply([], data.data) 
    $.each(data.links,function(k,v){
      var fromNodeIndex = flattenedData.indexOf(k)/2
      $.each(v,function(k,_v){
        var toNodeIndex = flattenedData.indexOf(k)/2
        if (toNodeIndex>0 && fromNodeIndex>0 && _v.length>0) {
          links.push(
          {
            'source':data.data[fromNodeIndex],
            'target':data.data[toNodeIndex],
            'stroke_width':_v.length,
            'stroke':median(_v)/10,
          })
        }
      })
    })
    return links
  }

  $.each(mapping,function(k,v) {
    var data = v.data
    var yscale = d3.scale.linear()
          .domain([d3.min(data,function(d){return d[1]}),d3.max(data, function(d){return d[1]})])
          .range([500,2500])
          .nice();

    var w = $('div.svg-container.'+k).width(),
        h = $('div.svg-container.'+k).height()

    var vis = d3.select("div.svg-container."+k).append("svg")
        .attr("width", w)
        .attr("height", h);

    var links = makeLinks(v)
    var force = d3.layout.force()
      .nodes(data)
      .links(links)
      .size([w, h])
      .gravity(0.01)
      .charge(-50)
      .linkStrength(0.2)
      .linkDistance(200)
      .start();

    var link = vis.selectAll("line.link")
      .data(force.links());

    link.enter().insert("svg:line", ".node")
      .attr("class", "link")
      .attr("x1", function(d) { return d.source.x; })
      .attr("y1", function(d) { return d.source.y; })
      .attr("x2", function(d) { return d.target.x; })
      .attr("y2", function(d) { return d.target.y; })
      .attr("style", function(d) { return "stroke-width: "+d.stroke_width+"; stroke: "+v.color.darker(d.stroke) })

    link.exit().remove();

    var node = vis.selectAll("g.node")
      .data(force.nodes()) 
      .enter().append("svg:g")
      .attr("class", "node")
      .attr("transform", function(d, i) {
        x = d.x
        y = d.y
        return "translate(" + x + "," + y + ")"; 
      })
      .call(force.drag)  

    node.append("circle")
          .transition().duration(1000)
          .attr("class", "node")
          .style('fill', v.color)
          //.attr('stroke', 'black')
          .attr("r", function(d){
            return Math.sqrt(yscale(d[1]));
          });
    
    // Add a text element to the previously added g element.
    node.append("text")
         .attr("text-anchor","middle")
         //.attr("transform", 'translate(0,-18)')
         .attr('fill','black')
         .attr('font-size','130%')
         .text(function(d) {
           return d[0]+" ("+d[1]+")";
         });

    vis.style("opacity", 1e-6)
      .transition()
        .duration(1000)
        .style("opacity", 1);


    force.on("tick", function(e) {
      // Push different nodes in different directions for clustering.
      // var k = 6 * e.alpha;
      // nodes.forEach(function(o, i) {
      //   o.y += i & 1 ? k : -k;
      //   o.x += i & 2 ? k : -k;
      // });
      link.attr("x1", function(d) { return d.source.x; })
        .attr("y1", function(d) { return d.source.y; })
        .attr("x2", function(d) { return d.target.x; })
        .attr("y2", function(d) { return d.target.y; });

      node.attr("transform", function(d) {
            return "translate("+d.x+","+d.y+")";
          });
    });
  });
	
});
</script>

<style>
  div.svg-container {
      height: 500px;
      width: 33%;
      float: left;
  }
  div.svg-container p {
    text-align: center;
    font-size: 3em;
  }
line {
  fill: none;
  stroke: #CC66FF;
</style>

<div class="svg-container one">
<p class="muted">Prolific</p>
</div>

<div class="svg-container two">
<p class="muted">Cited</p>
</div>

<div class="svg-container three">
<p class="muted">High impact</p>
</div>

<div style="margin-left:45%; margin-top:600px;">
  <p class="muted">Relationship depth: </p>
  <div class="btn-group" data-toggle="buttons-radio">
      <button id="btn-base" type="button" class="btn btn-primary"> 1 </button>
      <button id="btn-conn-authors" type="button" class="btn btn-primary"> 2 </button>
      <button id="btn-conn-institutes" type="button" class="btn btn-primary"> 3 </button>
      <button id="btn-conn-facilities" type="button" class="btn btn-primary"> 4 </button>
      <button id="btn-conn-words" type="button" class="btn btn-primary"> 5 </button>
  </div>
</div>
{% endblock %}


