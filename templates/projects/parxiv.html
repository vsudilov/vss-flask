{% extends "base.html" %}
{% block content %}


<script src="/static/js/d3.layout.cloud.js"></script>
<script>
//js in the html template because variable expansion from python (context) is easier this way

$(document).ready(function(){

  //$('.tooltip-help').tooltip()
  $('.tooltip-help').popover()
  
  $('#btn-base').button('toggle')

  $(document).on('click','button.change-relationship-level',function() {
    var id = $(this).attr('id')
    $.ajax({
        type: 'POST',
        url: '/projects/parxiv/',
        data: {
          'test':'testdata'
        },
        dataType: 'json',
        success: function(data, textStatus, jqXHR){
          console.log(data)
        },
        error: function(jqXHR,textStatus,errorThrown) {
          console.log(textStatus,errorThrown)
        }
    });
  });

  var wc = d3.select('div.svg-container-wc').append('svg')
    //.attr('style','border:1px solid blue')
    .attr('width',300)
    .attr('height',150)
  wc.append('text')
    .attr('class','tutorial')
    .attr('x',150)
    .attr('y',75)
    .attr('text-anchor','middle')
    .attr('fill','black')
    .attr('stroke-width',"1")
    .text('Commonly used words in abstracts')

  wc.append('text')
    .attr('class','tutorial')
    .attr('x',150)
    .attr('y',95)
    .attr('text-anchor','middle')
    .attr('fill','blue')
    .attr('stroke-width',"1")
    .text('(Click a node)')

  var ic = d3.select('div.svg-container-ic').append('svg')
    //.attr('style','border:1px solid blue')
    .attr('width',300)
    .attr('height',150)

  ic.append('text')
    .attr('class','tutorial')
    .attr('x',150)
    .attr('y',75)
    .attr('text-anchor','middle')
    .attr('fill','black')
    .attr('stroke-width',"1")
    .text('Commonly used words in titles')
  
  ic.append('text')
    .attr('class','tutorial')
    .attr('x',150)
    .attr('y',95)
    .attr('text-anchor','middle')
    .attr('fill','blue')
    .attr('stroke-width',"1")
    .text('(Click a node)')


  var render = function (mapping) {
    var makeLinks = function (data) {
      var median = function (values) {
   
        values.sort( function(a,b) {return a - b;} );
         
        var half = Math.floor(values.length/2);
         
        if (values.length % 2)
          return values[half];
        else
          return (values[half-1] + values[half]) / 2.0;
      }

      var links = []
      var flattenedData = Array.prototype.concat.apply([], data.data) 
      $.each(data.links,function(k,v){
        var fromNodeIndex = flattenedData.indexOf(k)/2
        $.each(v,function(k,_v){
          var toNodeIndex = flattenedData.indexOf(k)/2
          if (toNodeIndex>0 && fromNodeIndex>0 && _v.length>0) {
            links.push(
            {
              'source':data.data[fromNodeIndex],
              'target':data.data[toNodeIndex],
              'stroke_width':_v.length,
              'stroke':median(_v)/10,
            })
          }
        })
      })
      return links
    }

    $.each(mapping,function(k,v) {
      var data = v.data
      var yscale = d3.scale.linear()
            .domain([d3.min(data,function(d){return d[1]}),d3.max(data, function(d){return d[1]})])
            .range([500,2500])
            .nice();

      var w = $('div.svg-container.'+k).width(),
          h = $('div.svg-container.'+k).height()
      
      var prev_vis = $('div.svg-container.'+k+' svg')
      if ( prev_vis) { prev_vis.remove() }    

      var vis = d3.select("div.svg-container."+k).append("svg")
          .attr("width", w)
          .attr("height", h);

      var links = makeLinks(v)
      var force = d3.layout.force()
        .nodes(data)
        .links(links)
        .size([w, h])
        .gravity(0.01)
        .charge(-50)
        .linkStrength(0.2)
        .linkDistance(200)
        .start();

      var link = vis.selectAll("line.link")
        .data(force.links());

      link.enter().insert("svg:line", ".node")
        .attr("class", "link")
        .attr("x1", function(d) { return d.source.x; })
        .attr("y1", function(d) { return d.source.y; })
        .attr("x2", function(d) { return d.target.x; })
        .attr("y2", function(d) { return d.target.y; })
        .attr("style", function(d) { return "stroke-width: "+d.stroke_width+"; stroke: "+v.color.brighter(d.stroke) })

      link.exit().remove();

      var node = vis.selectAll("g.node")
        .data(force.nodes()) 
        .enter().append("svg:g")
        .attr("class", "node")
        .attr("transform", function(d, i) {
          x = d.x
          y = d.y
          return "translate(" + x + "," + y + ")"; 
        })
        .call(force.drag)  

      node.append("circle")
            .transition().duration(1000)
            .attr("class", "node")
            .style('fill', v.color)
            .attr("r", function(d){
              return Math.sqrt(yscale(d[1]));
            });
      
      // Add a text element to the previously added g element.
      node.append("text")
           .attr("text-anchor","middle")
           //.attr("transform", 'translate(0,-18)')
           .attr('fill','black')
           .attr('font-size','130%')
           .text(function(d) {
             return d[0]+" ("+d[1]+")";
           });

      vis.style("opacity", 1e-6)
        .transition()
          .duration(2000)
          .style("opacity", 1);
      


      vis.selectAll("g.node").on('click', function(d){
         var draw_titlewords = function (words) {
            ic.append("g")
              .attr('class','wordcloud')
              .attr("transform", "translate(150,75)")
            .selectAll("text")
              .data(words)
            .enter().append("text").transition().duration(2000)
              .style("font-size", function(d) { return d.size + "px"; })
              .style("font-family", "Impact")
              .style("fill", function(d, i) { return fill(i); })
              .attr("text-anchor", "middle")
              .attr("transform", function(d) {
                return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")";
              })
              .text(function(d) { return d.text; });
        }

        var draw_abstractwords = function (words) {
            wc.append("g")
              .attr('class','wordcloud')
              .attr("transform", "translate(150,75)")
            .selectAll("text")
              .data(words)
            .enter().append("text").transition().duration(2000)
              .style("font-size", function(d) { return d.size + "px"; })
              .style("font-family", "Impact")
              .style("fill", function(d, i) { return fill(i); })
              .attr("text-anchor", "middle")
              .attr("transform", function(d) {
                return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")";
              })
              .text(function(d) { return d.text; });
        }


        var fill = d3.scale.category20b();
        ic.selectAll('.tutorial').transition().duration(2000).style('opacity',0).remove()
        wc.selectAll('.tutorial').transition().duration(2000).style('opacity',0).remove()

        ic.selectAll('.wordcloud').remove()
        wc.selectAll('.wordcloud').remove()

        var w_title = authordata.titles[d[0]]
        var w_abstract = authordata.abstracts[d[0]]
        //[{text:"foo", size:5},...]
        
        var scale_title = d3.scale.linear()
          .domain(d3.extent(w_title, function(d) {return d.size}))
          .range([12,42])


        var scale_abstract = d3.scale.linear()
          .domain(d3.extent(w_abstract, function(d) {return d.size}))
          .range([12,42])

        d3.layout.cloud().size([300, 150])
            .words(w_abstract)
            .padding(4)
            .rotate(function() { return ~~(Math.random() * 2) * 90; })
            //.font("Impact")
            .fontSize(function(d) { return scale_abstract(d.size); })
            .on("end", draw_abstractwords)
            .start();

        d3.layout.cloud().size([300, 150])
            .words(w_title)
            .padding(4)
            .rotate(function() { return ~~(Math.random() * 2) * 90; })
            //.font("Impact")
            .fontSize(function(d) { return scale_title(d.size); })
            .on("end", draw_titlewords)
            .start();    
      })



      force.on("tick", function(e) {
        link.attr("x1", function(d) { return d.source.x; })
          .attr("y1", function(d) { return d.source.y; })
          .attr("x2", function(d) { return d.target.x; })
          .attr("y2", function(d) { return d.target.y; });

        node.attr("transform", function(d) {
              return "translate("+d.x+","+d.y+")";
            });
      });
    });
  }
  var mapping = {
    "one": {
      "data" :{{top_by_papercount|safe}},
      "color": d3.rgb(135,206,235),
      "links": {{relationships_by_papercount|safe}},
    },
    
    "two": {
      "data": {{top_by_citationcount|safe}},
      "color": d3.rgb(255,99,71),
      "links": {{relationships_by_citationcount|safe}},
    },

    "three": {
      "data": {{top_by_citationsperpaper|safe}},
      "color": d3.rgb(205,133,63),
      "links": {{relationships_by_citationsperpaper|safe}},
    },
  }

  var authordata = {{authordata|safe}}

  render(mapping)
  
});
</script>



<style>
  p {
    text-align: left;
    font-size: 1.2em;
  }
  div.svg-container {
      height: 450px;
      width: 33%;
      float: left;
  }
  div.svg-container p {
    text-align: center;
    font-size: 3em;
  }
  line {
    fill: none;
    stroke: #CC66FF;
  }
</style>


<div class="page-header">
  <div class="container-fluid">
    <div class="row">
      <div class="svg-container-wc span4"><p class="muted">Abstracts</p>
      </div>

      <div class="svg-container-ic span4"><p class="muted">Titles</p>
      </div>


      <div class="span8">
        <span class="muted">Relationship depth (Coming soon): </span>
        <div class="btn-group" data-toggle="buttons-radio">
            <button disabled="disabled" id="btn-base" type="button" class="btn btn-info change-relationship-level"> 0 </button>
            <button disabled="disabled" id="btn-conn-authors" type="button" class="btn btn-primary change-relationship-level"> 1 </button>
            <button disabled="disabled" id="btn-conn-institutes" type="button" class="btn btn-primary change-relationship-level"> 2 </button>
            <button disabled="disabled" id="btn-conn-facilities" type="button" class="btn btn-primary change-relationship-level"> 3 </button>
            <button disabled="disabled" id="btn-conn-words" type="button" class="btn btn-primary change-relationship-level"> 4 </button>
        </div>


        <button type="button" class="btn btn-info" data-toggle="collapse" data-target="#help">
          What am I looking at?
        </button>

        <div id="help" class="collapse" style="margin-top:20px;">
          <p>
            Below is a representation of the <b>top 10 authors</b> in three categories:
            <ul class='unstyled'>
                <li>Most publications (prolific)</li>
                <li>Most citations (cited)</li>
                <li>Highest ratio of papers/citations (high impact)</li>
            </ul>
          </p>

          <p>
              <b>Links</b> between authors represent a connection of authors in their papers:
              <ul class='unstyled'>
                  <li>Larger links represent higher frequency of co-authorship</li>
                  <li>Darker links represent higher rank of co-authorship (closer to top of author list)</li>
              </ul>
          </p>

          <p>
            <b>Relationship depth</b> refers to how many papers removed an author is from another.
            <ul class='unstyled'>
                <li>0: Authors are directly linked as co-authors</li>
                <li>1: Authors are linked through exactly 1 co-author</li>
                <li>2: Authors are linked through exactly 2 co-authors</li>
            </ul>
          </p>
        </div>
      </div>





    </div>
  </div>

</div>

<div class="svg-container one">
<p class="muted">Prolific</p>
</div>

<div class="svg-container two">
<p class="muted">Cited</p>
</div>

<div class="svg-container three">
<p class="muted">High impact</p>
</div>

{% endblock %}


